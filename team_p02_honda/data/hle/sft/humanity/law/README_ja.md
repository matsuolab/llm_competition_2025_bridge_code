# 法律データセットフォーマッター

## 概要

このツールは、Hugging Faceから[CoT_Legal_Issues_And_Lawsデータセット](https://huggingface.co/datasets/moremilk/CoT_Legal_Issues_And_Laws)を処理し、難易度レベルで法律の質問をフィルタリングし、明示的な推論トレースを含む構造化されたSFT（教師あり微調整）形式に変換します。

## 処理パイプライン

```mermaid
flowchart TD
    A[HuggingFaceデータセット<br/>moremilk/CoT_Legal_Issues_And_Laws] --> B[データセット読み込み<br/>format_law.py]
    
    B --> C[DataFrameに変換]
    C --> D[メタデータを抽出]
    
    D --> E[難易度レベルを解析]
    E --> F{難易度でフィルタリング<br/>≥ 閾値}
    
    F -->|閾値未満| G[除外]
    F -->|閾値以上| H[含める]
    
    H --> I[形式を変換]
    
    I --> J[コンポーネントを抽出]
    J --> K[質問フィールド]
    J --> L[メタデータから推論]
    J --> M[回答フィールド]
    
    K --> N[構造を構築]
    L --> N
    M --> N
    
    N --> O[SFTエントリを作成]
    O --> P[ID生成<br/>law_{index}]
    O --> Q[出力をフォーマット<br/>&lt;think&gt;推論&lt;/think&gt;<br/>回答]
    
    P --> R[フィールドを結合]
    Q --> R
    
    R --> S[結果に追加]
    G --> T[統計をログ]
    
    S --> U{他の行がある？}
    T --> U
    U -->|はい| F
    U -->|いいえ| V[JSONを保存]
    
    V --> W[law.json<br/>results/law/内]
    
    style A fill:#e1f5fe
    style W fill:#c8e6c9
    style G fill:#ffcdd2
```

### 処理パイプラインのステップごとの説明

1. **データセット読み込み**  
   `format_law.py`スクリプトを使用して、Hugging Faceから`moremilk/CoT_Legal_Issues_And_Laws`データセットを読み込むことから処理が始まります。

2. **DataFrameに変換**  
   生データは、操作と分析を容易にするためにpandas DataFrameに変換されます。

3. **メタデータを抽出**  
   各データエントリから難易度や推論などのメタデータフィールドが抽出されます。

4. **難易度レベルを解析**  
   スクリプトはメタデータから難易度レベルを解析し、各法律質問の複雑さを判断するために使用されます。

5. **難易度でフィルタリング**  
   各エントリが評価されます：  
   - 難易度が指定された閾値**未満**の場合、エントリはさらなる処理から**除外**されます。  
   - 難易度が閾値**以上**の場合、エントリは次のステップのために**含まれます**。

6. **形式を変換**  
   含まれたエントリは、SFT（教師あり微調整）要件に合致するように形式変換の準備がされます。

7. **コンポーネントを抽出**  
   含まれた各エントリに対して、以下のコンポーネントが抽出されます：  
   - **質問フィールド**: 元の法律の質問  
   - **メタデータからの推論**: ステップバイステップの法的推論プロセス  
   - **回答フィールド**: 法律の質問に対する最終回答

8. **構造を構築**  
   抽出されたコンポーネントが結合されて、構造化されたデータエントリを形成します。

9. **SFTエントリを作成**  
   各構造化エントリに対して：  
   - **ID生成**: `law_{index}`形式で一意の識別子を割り当てます  
   - **出力をフォーマット**: 推論（`<think>...</think>`で囲まれた）と回答を単一の出力フィールドに結合します

10. **フィールドを結合**  
    ID、質問、フォーマットされた出力、および回答が最終的なSFTエントリに組み立てられます。

11. **結果に追加**  
    完成したSFTエントリが結果リストに追加されます。

12. **統計をログ**  
    除外されたエントリ（難易度閾値未満のもの）については、報告と分析のために統計がログに記録されます。

13. **すべての行を反復処理**  
    すべてのエントリが処理されるまで、データセット内の各行に対してプロセスが繰り返されます。

14. **JSONを保存**  
    すべてのエントリが処理されると、結果は`results/law/`ディレクトリにJSONファイル（`law.json`）として保存されます。

このパイプラインにより、十分な難易度の法律の質問のみが含まれ、各エントリが教師あり微調整タスクに適した一貫性のある構造化された形式に変換されることが保証されます。

## 機能

- **難易度ベースのフィルタリング**: 複雑さレベルに基づいて法律の質問を選択
- **メタデータ抽出**: データセットのメタデータから難易度と推論を解析
- **形式変換**: thinkタグを含む構造化されたSFT形式に変換
- **バッチ処理**: データセット全体の分割を効率的に処理
- **統計レポート**: フィルタリング結果とデータ分布を表示

## データセット情報

### ソース
- **リポジトリ**: Hugging Face - `moremilk/CoT_Legal_Issues_And_Laws`
- **タイプ**: 思考の連鎖説明を含む法的推論データセット
- **分割**: トレーニングセット（デフォルト）

### データフィールド
- **question**: 法律の質問またはシナリオ
- **answer**: 法律の質問に対する最終回答
- **metadata**: 難易度レベルと推論プロセスを含む
  - **difficulty**: 質問の複雑さを示す整数値（1-5）
  - **reasoning**: ステップバイステップの法的推論

## 出力形式

### SFT構造
```json
{
  "id": "law_0",
  "question": "...の法的な意味合いは何ですか？",
  "output": "<think>法的推論プロセス...</think>\n最終的な法的回答",
  "answer": "最終的な法的回答"
}
```

### フィールドの説明
- **id**: `law_{index}`形式の一意の識別子
- **question**: データセットからの元の法律の質問
- **output**: 結合された推論（thinkタグ内）と回答
- **answer**: スタンドアロンの最終回答

## 使用方法

### 基本的な使用方法
```bash
# デフォルト設定で処理（難易度 >= 4）
python format_law.py
```

### カスタム難易度フィルタリング
```bash
# 高難易度の質問のみを含める（5以上）
python format_law.py --difficulty 5

# すべての質問を含める（難易度 >= 1）
python format_law.py --difficulty 1
```

### 高度なオプション
```bash
python format_law.py \
  --split train \
  --difficulty 3 \
  --output ../custom_results/law \
  --show-sample
```

### コマンドライン引数
- `--split`: 読み込むデータセット分割（デフォルト: "train"）
- `--difficulty`: 最小難易度閾値（デフォルト: 4）
  - 1: 非常に簡単
  - 2: 簡単
  - 3: 中程度
  - 4: 難しい
  - 5: 非常に難しい
- `--output`: 出力ディレクトリパス（デフォルト: "../results/law"）
- `--show-sample`: フィルタリングされたデータのサンプルを表示

## 処理ステップ

### 1. データセット読み込み
- Hugging FaceからCoT_Legal_Issues_And_Lawsデータセットを読み込み
- 効率的な操作のためにpandas DataFrameに変換
- データセット統計と列情報を表示

### 2. メタデータ抽出
- メタデータフィールドを解析して難易度レベルを抽出
- フィルタリング用の専用難易度列を作成

### 3. 難易度フィルタリング
- 指定された難易度閾値に基づいて質問をフィルタリング
- 閾値を満たすか超える質問のみを保持
- フィルタリング統計と分布を報告

### 4. 形式変換
- フィルタリングされたエントリを反復処理
- 質問、推論、回答コンポーネントを抽出
- `<think>`タグで推論をフォーマット
- コンポーネントをSFT構造に結合

### 5. 出力生成
- 存在しない場合は出力ディレクトリを作成
- 適切なインデントでフォーマットされたデータをJSONとして保存
- トレーニング目的のためにすべての法的推論を保持

## 出力統計

ツールは以下を含む詳細な統計を提供します：
- 読み込まれた総サンプル数
- フィルタリング後のサンプル数
- フィルタリングされたデータの難易度分布
- サンプルプレビュー（リクエスト時）

## 要件

### 依存関係
```bash
pip install datasets pandas
```

### システム要件
- Python 3.7以上
- データセットダウンロード用のインターネット接続
- データセットキャッシュ用の十分なディスク容量

## ファイル構造
```
law/
├── format_law.py       # メイン処理スクリプト
├── README.md          # 英語版ドキュメント
├── README_ja.md       # このドキュメント（日本語版）
└── results/           # 出力ディレクトリ（自動作成）
    └── law/
        └── law.json   # フォーマットされた出力ファイル
```

## 出力例

### 入力（データセットから）
```json
{
  "question": "口頭契約は法的拘束力がありますか？",
  "answer": "はい、口頭契約は法的拘束力を持つことができます...",
  "metadata": {
    "difficulty": 4,
    "reasoning": "口頭契約が法的拘束力を持つかどうかを判断するには、考慮する必要があります..."
  }
}
```

### 出力（SFT形式）
```json
{
  "id": "law_42",
  "question": "口頭契約は法的拘束力がありますか？",
  "output": "<think>口頭契約が法的拘束力を持つかどうかを判断するには、考慮する必要があります...</think>\nはい、口頭契約は法的拘束力を持つことができます...",
  "answer": "はい、口頭契約は法的拘束力を持つことができます..."
}
```

## エラー処理

スクリプトには以下の堅牢なエラー処理が含まれています：
- データセット読み込みの失敗
- 欠落したメタデータフィールド
- 無効な難易度値
- ファイルシステム操作

## パフォーマンスの考慮事項

- **メモリ使用量**: DataFrameの操作はメモリ効率的
- **処理速度**: フィルタリング用のベクトル化された操作
- **出力サイズ**: 可読性のためのインデント付きJSONフォーマット

## 開発

### ツールの拡張

処理をカスタマイズするには：

1. **カスタムフィルターの追加**: 追加基準のために`filter_by_difficulty()`を変更
2. **出力形式の変更**: 異なる構造のために`transfer_data_format()`を更新
3. **前処理の追加**: 変換前にデータクリーニングステップを挿入
4. **追加メタデータを含める**: メタデータからより多くのフィールドを抽出

### テスト
```python
# 小さなサブセットでテスト
python format_law.py --difficulty 4 --show-sample
```

## トラブルシューティング

### よくある問題

1. **データセットのダウンロードが失敗する**
   ```bash
   # インターネット接続を確認
   # Hugging Faceの可用性を確認
   # 破損している場合はキャッシュをクリア
   rm -rf ~/.cache/huggingface/datasets/moremilk___cot_legal_issues_and_laws
   ```

2. **メモリの問題**
   - スクリプトを変更してバッチで処理
   - より多くのRAMを持つマシンを使用
   - より積極的にフィルタリング

3. **欠落した難易度値**
   - スクリプトは欠落値を優雅に処理
   - エラーが発生した場合はメタデータ構造を確認

## ライセンス

このツールは教育および研究目的で提供されています。データ自体に関するライセンス情報については、元の[CoT_Legal_Issues_And_Lawsデータセット](https://huggingface.co/datasets/moremilk/CoT_Legal_Issues_And_Laws)を参照してください。